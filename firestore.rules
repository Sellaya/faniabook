/**
 * @fileOverview Firestore Security Rules for FaniaBook.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, bookings, reviews, and contracts. Each user can only access their own data. AI review summaries are open for public read, but restricted for writing.
 *
 * Data Structure:
 * All user-related data is nested under /users/{userId}, ensuring clear ownership. AI review summaries are stored in a separate top-level collection, /ai_review_summaries/{aiReviewSummaryId}.
 *
 * Key Security Decisions:
 *  - User data is strictly private; users can only access their own profiles, bookings, reviews, and contracts.
 *  - Listing operations are restricted to the owner of the parent document for user subcollections.
 *  - AI review summaries are publicly readable but require custom write rules (currently denied).
 *
 * Denormalization for Authorization:
 *  - The data structure uses path-based ownership. Rules can directly check if `request.auth.uid == userId` without additional `get()` calls.
 *
 * Structural Segregation:
 *  - Public (AI review summaries) and private (user data) are in separate collections to avoid using boolean flags for access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Public booking collection.
     * @path /bookings/{bookingId}
     * @allow create: Anyone can create a booking.
     * @allow get: Anyone can read a booking if they have the ID.
     * @deny (list, update, delete): Not allowed.
     */
    match /bookings/{bookingId} {
      allow create: if true;
      allow get: if true;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}/profile
     * @allow (create, update, delete): Authenticated user with matching userId can modify their profile.
     * @allow (get, list): Authenticated user with matching userId can read their profile.
     * @deny (create, update, delete): Any other user attempts to modify this profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/profile {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to booking documents under a specific user.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow (create, update, delete): Authenticated user with matching userId can manage their bookings.
     * @allow (get, list): Authenticated user with matching userId can view their bookings.
     * @deny (create, update, delete): Any other user attempts to modify these bookings.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to review documents for a specific booking under a user.
     * @path /users/{userId}/bookings/{bookingId}/reviews/{reviewId}
     * @allow (create, update, delete): Authenticated user with matching userId can manage their reviews.
     * @allow (get, list): Authenticated user with matching userId can view their reviews.
     * @deny (create, update, delete): Any other user attempts to modify these reviews.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/bookings/{bookingId}/reviews/{reviewId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to contract documents associated with a booking under a user.
     * @path /users/{userId}/bookings/{bookingId}/contracts/{contractId}
     * @allow (create, update, delete): Authenticated user with matching userId can manage their contracts.
     * @allow (get, list): Authenticated user with matching userId can view their contracts.
     * @deny (create, update, delete): Any other user attempts to modify these contracts.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/bookings/{bookingId}/contracts/{contractId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.bookingId == bookingId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.bookingId == bookingId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to AI review summary documents.
     * @path /ai_review_summaries/{aiReviewSummaryId}
     * @allow (get, list): Allow public read access.
     * @deny (create, update, delete):  Writes are not allowed at this time.
     * @principle Allows public read access but restricts write access for AI review summaries.
     */
    match /ai_review_summaries/{aiReviewSummaryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add write access rules if needed in the future.
      allow update: if false; // TODO: Add write access rules if needed in the future.
      allow delete: if false; // TODO: Add write access rules if needed in the future.
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @returns {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the resource.
   * @param {string} userId The user ID to check against.
   * @returns {boolean} True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

    /**
   * @description Checks if the user is the owner of the resource and if the resource exists.
   * @param {string} userId The user ID to check against.
   * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}
